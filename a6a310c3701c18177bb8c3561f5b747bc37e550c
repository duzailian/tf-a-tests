{
  "comments": [
    {
      "key": {
        "uuid": "b82f40db_45e8a40d",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-24T20:26:15Z",
      "side": 1,
      "message": "why do you need this ? is it to order the sev() in tftf_send_event()?",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "108b19f2_c4a4e10e",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-24T21:45:14Z",
      "side": 1,
      "message": "Honestly, I am not sure how the barrier is helping. After some debug, I found that without this barrier, the test hangs as the primary CPU keeps waiting for this event from the secondary CPU.",
      "parentUuid": "b82f40db_45e8a40d",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bab008e4_6d524e64",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-24T21:52:53Z",
      "side": 1,
      "message": "alright thanks. This is common code so the barrier may mask issues on other platforms. Is this on a particular CPU or is this on FVP?",
      "parentUuid": "108b19f2_c4a4e10e",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8f6a5af3_f788f980",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-24T22:18:37Z",
      "side": 1,
      "message": "I am running this test on Juno board since it is a real platform and has GICv2. On a side note, this test still fails on Juno board with the error message shown on lines 105-111. This barrier (line 69) is helping to at least get a clean fail rather than a test hang. The test always hangs on FVP , even with this change, but I am suspecting it could be a bug in FVP model related to modeling of spurious interrupts with GICv2.",
      "parentUuid": "bab008e4_6d524e64",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1154fdb6_2c143df4",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 69,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-24T22:29:00Z",
      "side": 1,
      "message": "Interesting. Might be interesting to get more data points on other platforms if possible. No intent to block this patch, this is idle curiosity as mentioned in the below comment as well.",
      "parentUuid": "8f6a5af3_f788f980",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1e7b81e8_67723bfa",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-24T20:26:15Z",
      "side": 1,
      "message": "not sure i understand this either. This sounds like writing to the GICD_ITARGET register will complete at the CPU but its effect will take longer ? So the GIC responds to the write before the effects have taken place?",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "62f01c45_8be21c83",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-24T21:45:14Z",
      "side": 1,
      "message": "Yes, my understanding of the GICv2 spec is that any change to CPU target field values takes a small but finite amount of time to take affect. Please note that the choice of 5000 ms was arbitrary based on trial and error.",
      "parentUuid": "1e7b81e8_67723bfa",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8106efdf_22934666",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-24T21:52:53Z",
      "side": 1,
      "message": "same here. I fear this is masking some other issue. This was working until now right ?",
      "parentUuid": "62f01c45_8be21c83",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "afd6161e_51becc40",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-24T22:18:37Z",
      "side": 1,
      "message": "Thanks for the feedback. You could be right that it is masking some other issue. The delay might still be needed but not as large as 5000 ms. \nOn a side note, I looked at the events library APIs and was wondering if it is completely MP-safe.",
      "parentUuid": "8106efdf_22934666",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3173e061_cf148bf9",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-24T22:29:00Z",
      "side": 1,
      "message": "event api\u0027s looked safe to me(first thing i checked when you said there was a hang). Did some code in particular not look right to you? Might be worth asking other platforms to try this and see if they see hangs as well. Anyway, i don\u0027t want to block this patch. This is more idle curiosity for me than anything else.",
      "parentUuid": "afd6161e_51becc40",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ba69373f_97a8b41b",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-24T22:56:19Z",
      "side": 1,
      "message": "Since adding a barrier helped to resolve the test hang, my natural instinct was to question if the events library is mp-safe though I have no strong proof of it. I could be completely wrong but I was wondering if a dsbishst is required between spin_unlock() and sev() in the send_event_common() function.",
      "parentUuid": "3173e061_cf148bf9",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ea63bc70_198ebc01",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-24T22:57:25Z",
      "side": 1,
      "message": "Hi Varun,\n\nCan you help to run this test on your nvidia t194 board?",
      "parentUuid": "ba69373f_97a8b41b",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f1641018_b63fc9c4",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000162
      },
      "writtenOn": "2020-06-25T00:11:47Z",
      "side": 1,
      "message": "Hi, Tegra194 platforms dont support TSP out of the box. We only support TLK and Trusty. So Im not sure if I can run this test immediately. If this is urgent, I will try to spend some time.\n\n-Varun",
      "parentUuid": "ea63bc70_198ebc01",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d84edabf_c02a4ddf",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-25T00:13:24Z",
      "side": 1,
      "message": "i may be seeing the problem here. If sev() gets reordered above the event-\u003ecnt+\u003dinc statement in send_event_common() on say core 0, and lets say core 1 is in wfe in tftf_wait_for_event, it gets the event before the write to event-\u003ecnt from core 0 propagates to the other core, wakes up, reads event-\u003ecnt, sees that it is 0 and goes back to wfe. You may be right that you need a barrier to ensure the sev is not reordered before the spin_unlock(). I\u0027m not able to find the ordering requirements for sev in the arm arm.. do you know off the top of your head? i think that might be the issue.",
      "parentUuid": "ea63bc70_198ebc01",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "57694df7_ff9bad21",
        "filename": "tftf/tests/runtime_services/trusted_os/tsp/test_irq_spurious_gicv2.c",
        "patchSetId": 1
      },
      "lineNbr": 237,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2020-06-25T00:30:41Z",
      "side": 1,
      "message": "I am glad we are on the same page and thanks for the detailed set of events. I spent sometime today to find the ordering requirements/behavior of sev() but I didnt find anything concrete. I will try to follow up with folks from Arm to understand if our theory holds well. I will create a bare metal synchronization test using this library and pthreads to reproduce this issue.\n\nHi Varun,\nI cannot say this is urgent. Please take up this investigation at your convenience.",
      "parentUuid": "d84edabf_c02a4ddf",
      "revId": "a6a310c3701c18177bb8c3561f5b747bc37e550c",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    }
  ]
}