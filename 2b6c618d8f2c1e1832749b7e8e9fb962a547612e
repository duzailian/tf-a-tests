{
  "comments": [
    {
      "key": {
        "uuid": "2d8958ad_4321c0f0",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-18T22:04:37Z",
      "side": 1,
      "message": "why do you need a ret? This is a macro, so cannot be called from C files and if it is to be used in assembly, it can only be used at the end of a function. Seems like it is coded to be used only in the amu file... might want to leave out the ret here and keep the ret instruction in the amu assembly.",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "82b1ef16_a59fc707",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000105
      },
      "writtenOn": "2020-06-19T12:18:02Z",
      "side": 1,
      "message": "This is macro which defines a function, which is called by \"br x1\" instruction.\nSee definition in TF-A:\nhttps://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/tree/include/arch/aarch64/asm_macros.S#n200\nIts usage in TF-A:\nhttps://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/tree/lib/extensions/amu/aarch64/amu_helpers.S#n43\nIts usage in TFTF:\nhttps://review.trustedfirmware.org/c/TF-A/tf-a-tests/+/4622/2/lib/extensions/amu/aarch64/amu_helpers.S#40",
      "parentUuid": "2d8958ad_4321c0f0",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c8d0c540_b0f4c2fd",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-19T15:13:04Z",
      "side": 1,
      "message": "\"this is MACRO which defines a FUCNTION\" - The statement itself is confusing. Would you consider func read reg:req instead? It is confusing to a reader(at least me) if it is a macro and ends with a ret. If it is a func, it\u0027ll be clear that this can be called using a branch instruction. The macro seems not useful anywhere else except in the amu_helper.S the way it is written and your links suggest that too. This can be a generic macro/func that can be used in other places too if the ret is removed.\n\nMoreover, i question the usefulness of the bti instruction in this case. This is a perfect gadget to read system registers for ROP/JOP attacks by the very fact that bti has been added followed by one instruction followed by a ret. I wonder if the same function from amu_helpers.S was written in C, what code the compiler would generate. If it ends up spraying a bunch of BTI\u0027s like we are doing here, then i guess it is okay.",
      "parentUuid": "82b1ef16_a59fc707",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "71fcad01_247f92df",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000105
      },
      "writtenOn": "2020-06-19T16:16:14Z",
      "side": 1,
      "message": "What\u0027s about these macros here:\n\nhttps://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/tree/lib/cpus/aarch64/wa_cve_2017_5715_bpiall.S#n18\n.macro\tapply_cve_2017_5715_wa _from_vector\n\t/*\n\t * Save register state to enable a call to AArch32 S-EL1 and return\n\t * Identify the original calling vector in w2 (\u003d\u003d_from_vector)\n\t * Use w3-w6 for additional register state preservation while in S-EL1\n\t */\n\n\t/* Save GP regs */\n\tstp\tx0, x1, [sp, #CTX_GPREGS_OFFSET + CTX_GPREG_X0]\n....\nmsr\tscr_el3, xzr\n\tmsr\tspsr_el3, x8\n\tmsr\tvbar_el3, x9\n\tmsr\tsctlr_el1, x10\n\tmsr\telr_el3, x11\n\n\teret\n\t.endm\n\nand here\n\nhttps://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/tree/lib/aarch64/cache_helpers.S#n22\nhttps://git.trustedfirmware.org/TF-A/tf-a-tests.git/tree/lib/aarch64/cache_helpers.S#n22\n\n/*\n * This macro can be used for implementing various data cache operations `op`\n */\n.macro do_dcache_maintenance_by_mva op\n\t/* Exit early if size is zero */\n\tcbz\tx1, exit_loop_\\op\n\tdcache_line_size x2, x3\n\tadd\tx1, x0, x1\n\tsub\tx3, x2, #1\n\tbic\tx0, x0, x3\nloop_\\op:\n\tdc\t\\op, x0\n\tadd\tx0, x0, x2\n\tcmp\tx0, x1\n\tb.lo    loop_\\op\n\tdsb\tsy\nexit_loop_\\op:\n\tret\n.endm\n\nAre you suggesting that (e)ret instructions should be removed or macros replaced with functions?\n\nShow me in that definition of macro:\n\nhttp://www.keil.com/support/man/docs/armasm/armasm_dom1359731154916.htm\n\"A macro definition is a block of code enclosed between MACRO and MEND directives. It defines a name that you can use as a convenient alternative to repeating the block of code.\nThe main uses for a macro are:\n    To make it easier to follow the logic of the source code by replacing a block of code with a single meaningful name.\n    To avoid repeating a block of code several times.\"\n\nwhere it is said that it is not allowed to have a (e)ret instruction.\n\nThis change matches the similar TF-A code (except that there is no write macro) and commit message clearly states that. This macro can be used not only in amy_helper.S but in any other driver which needs the same sort of calling method (blr x, br x).\n\nYou wrote:\n\"Would you consider func read reg:req instead?\"\n\nLook at\nhttps://git.trustedfirmware.org/TF-A/tf-a-tests.git/tree/include/common/asm_macros_common.S#n17\n\nAre you aware that \"func\" is a macro itself?\n.macro func _name\n\nand would you explain how \"func\" can get system register as a parameter to use in \"mrs\" instruction?",
      "parentUuid": "c8d0c540_b0f4c2fd",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1deaa502_71f4a4bb",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000105
      },
      "writtenOn": "2020-06-19T16:18:43Z",
      "side": 1,
      "message": "I didn\u0027t write anytning about \"FUCNTION\"",
      "parentUuid": "71fcad01_247f92df",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c1c08abb_530c7467",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-19T17:03:11Z",
      "side": 1,
      "message": "\u003e\u003eThis change matches the similar TF-A code\n\nThanks for the explanation. Firstly, \"what about\u0027s\" are not an answer to everything. Just because something has been done in the past does not mean we have to follow it in the future. I urge you to consider the possibility that we can always improve and not blindly follow what has been done in the past. Not everything is perfect in TF-A:)\n\nHave you considered that the examples you showed may have been doing it incorrectly? Have you noticed the macros are in their own files and not in the generic asm_macros.S file? Can you think of why that may be the case? And if you look at the rest of the macros in this file, do you see anything ending with ret? Does that not seem odd and worth questioning? Using your own logic, if you consider macro patterns(not func, which is a special macro which indicates usage of ret) in TF-A, would you not consider having RET\u0027s in the macro an outlier rather than the norm?\n\nSince you pointed out func is a macro(which i forgot and missed the parameter aspect of it), have you considered that maybe you need a better name than simply \"read\" or \"write\" that provides no context about it being called by br x1. Other than you, the code author, nobody knows these hidden details and assumptions, which can be missed while reviewing code. Have you considered that i may have missed that because of the way the code is written? Instead of \"what about\u0027s\" can you consider discussing how you can help make it clearer to a reader? Perhaps a nice long comment on top of the macro? Maybe the macro can live in amu_helpers.S?\n\n\u003e\u003eAre you suggesting that (e)ret instructions should be removed or macros replaced with \u003e\u003efunctions ? where it is said that it is not allowed to have a (e)ret instruction.\n\nJust because something is unsaid, does not mean it is not worth thinking about. See above. How many macros in TF-A end with an ERET or RET? It just seems odd for THIS macro to end with RET which is why i posted a comment. i can see it happening with function epilogues for example but that would give you an indication about it being a function epilogue, perhaps by its name.",
      "parentUuid": "71fcad01_247f92df",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "782829de_ddfec2de",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000105
      },
      "writtenOn": "2020-06-19T17:45:49Z",
      "side": 1,
      "message": "Please feel free to raise a defect for using \"(e)ret\" instructions in TF-A and TFTF source trees and to provide a solution for fixing that issue.\nWould you give a working example of a single function which will accept system register name as a parameter for \"mrs\" and can be used for 20 places in TFTF and TF-A code where it is called?",
      "parentUuid": "c1c08abb_530c7467",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "caaf6579_994a6c66",
        "filename": "include/common/aarch64/asm_macros.S",
        "patchSetId": 2
      },
      "lineNbr": 203,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2020-06-19T18:27:16Z",
      "side": 1,
      "message": "i already conceded that you cannot use a function, obviously, so the macro is fine. I recommend changing the name to something like read_sys_reg_ret/write_sys_reg_ret, adding a comment that says this is expected to be invoked only by a br instruction when BTI is enabled. The _ret post-fix should hopefully be clear enough that the macro includes a ret. amu_helpers.S otherwise looks like it is a sequence of reads and completely misses the hidden ret.",
      "parentUuid": "782829de_ddfec2de",
      "revId": "2b6c618d8f2c1e1832749b7e8e9fb962a547612e",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda",
      "unresolved": true
    }
  ]
}