{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "4404d9ec_5be39575",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-01T14:58:40Z",
      "side": 1,
      "message": "Any callers using tftf_smc() will have SVE hint bit set in SMC FID if the CPU supports SVE and SVE traps are enabled in trap register (cptr_el2 for EL2 payload and cpacr_el1 for EL1 payload).\n\nThis change breaks four world testing, on SVE enabled config. Cactus SP runs with cpacr_el1.zen\u003d0, and some code path in Cactus uses tftf_smc, and this set SVE hint bit. The ffa_handler() in Hafnium currently doesn\u0027t discard SVE hint bit in SMC FID as part of the function identification and this causes the boot to fail.\n\nThis needs investigation if tftf_smc used in Cactus can be replaced with ffa_smc or ffa_service_call.",
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ddae3b35_83f94d8e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T13:33:59Z",
      "side": 1,
      "message": "Comment removed by: Olivier Deprez; Reason: (fixed typos)",
      "parentUuid": "4404d9ec_5be39575",
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3a04bc64_938de430",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T13:35:13Z",
      "side": 1,
      "message": "\u003e some code path in Cactus uses tftf_smc\n\nyes this looks a bit inconsistent, maybe we can fix this as you mentioned\n\n\u003e and this set SVE hint bit.\n\nHum, I wonder why this is the case.\nFirst problem hafnium returns SVE supported from ID regs when it shouldn\u0027t (known issue).\nThen I miss the point of using trap control to represent the SVE hint bit. I assume we want to test cases where SVE hint bit is set OR not set? It seems like with this approach we can only test one of such case.",
      "parentUuid": "ddae3b35_83f94d8e",
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "372b346e_5932ed3b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T16:09:00Z",
      "side": 1,
      "message": "I think as a workaround you could do:\n\n    diff --git a/lib/smc/aarch64/smc.c b/lib/smc/aarch64/smc.c\n    index de0ee6903..9420b24d6 100644\n    --- a/lib/smc/aarch64/smc.c\n    +++ b/lib/smc/aarch64/smc.c\n    @@ -96,11 +96,14 @@ smc_ret_values tftf_smc(const smc_args *args)\n    {\n        uint32_t fid \u003d args-\u003efid;\n \n    +#if IMAGE_TFTF\n    +\n           if (tftf_smc_get_sve_hint()) {\n                   fid |\u003d MASK(FUNCID_SVE_HINT);\n           } else {\n                   fid \u0026\u003d ~MASK(FUNCID_SVE_HINT);\n           }\n    +#endif\n \n     asm_tftf_smc64(fid,\n                              args-\u003earg1,",
      "parentUuid": "3a04bc64_938de430",
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "092d2372_45d029b3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 11
      },
      "lineNbr": 0,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-08T11:22:23Z",
      "side": 1,
      "message": "\u003e I assume we want to test cases where SVE hint bit is set OR not set? It seems like with this approach we can only test one of such case.\n\nYes, now control register SVE field represent the SVE hint bit. I have added more comments related to this logic at:https://review.trustedfirmware.org/c/TF-A/tf-a-tests/+/23093/comment/e15b9838_03a5f573/\n\n\n\u003e I think as a workaround you could do:\n\n\u003e     +#if IMAGE_TFTF\n\u003e     +\n\u003e            if (tftf_smc_get_sve_hint()) {\n\u003e                    fid |\u003d MASK(FUNCID_SVE_HINT);\n\u003e            } else {\n\u003e                    fid \u0026\u003d ~MASK(FUNCID_SVE_HINT);\n\u003e            }\n\u003e     +#endif\n\nThanks for the suggestion. I will look at adding this option, as the realm payload also uses tftf_smc() I may have to add an extra build flag.",
      "parentUuid": "372b346e_5932ed3b",
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "700f469f_7cc2860a",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 39,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T13:33:59Z",
      "side": 1,
      "message": "I wonder why creating macros? Why can\u0027t this be a simple or inlined function?\nThis makes the passing of flags argument confusing at call sites (used as an output for sve_traps_save_disable and an input for sve_traps_restore).",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 39,
        "endChar": 0
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8645bb56_efc03cec",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 39,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-28T17:11:11Z",
      "side": 1,
      "message": "I guess this is local to the file and used within the local scope, I dont have any opinion either way. I guess these kind of operations are traditionally macros in linux kernel and hence the pattern here (eg: spin_lock_irqsave ). Will leave to this to Arun\u0027s preference.",
      "parentUuid": "700f469f_7cc2860a",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 39,
        "endChar": 0
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fc5d0ee2_21e58295",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 39,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-29T09:20:45Z",
      "side": 1,
      "message": "Ok.",
      "parentUuid": "8645bb56_efc03cec",
      "range": {
        "startLine": 17,
        "startChar": 0,
        "endLine": 39,
        "endChar": 0
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2731e476_96174f60",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 40,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T13:33:59Z",
      "side": 1,
      "message": "Unnecessary.",
      "range": {
        "startLine": 40,
        "startChar": 7,
        "endLine": 40,
        "endChar": 13
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fd05806b_7097624f",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 40,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-08T11:22:23Z",
      "side": 1,
      "message": "\u003e Unnecessary.\n\nRemoved",
      "parentUuid": "2731e476_96174f60",
      "range": {
        "startLine": 40,
        "startChar": 7,
        "endLine": 40,
        "endChar": 13
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3e40dbe2_4c40f5ab",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 45,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T13:33:59Z",
      "side": 1,
      "message": "Unnecessary.",
      "range": {
        "startLine": 45,
        "startChar": 7,
        "endLine": 45,
        "endChar": 13
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fac47a7c_53c4dab4",
        "filename": "lib/extensions/sve/aarch64/sve.c",
        "patchSetId": 11
      },
      "lineNbr": 45,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-08T11:22:23Z",
      "side": 1,
      "message": "Removed",
      "parentUuid": "3e40dbe2_4c40f5ab",
      "range": {
        "startLine": 45,
        "startChar": 7,
        "endLine": 45,
        "endChar": 13
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e15b9838_03a5f573",
        "filename": "lib/smc/aarch64/smc.c",
        "patchSetId": 11
      },
      "lineNbr": 65,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-02T13:33:59Z",
      "side": 1,
      "message": "I don\u0027t really understand this logic.\nWhy do we directly associate the SVE hint bit passed through SMC to the trap control?\nAs we can have traps disabled and SVE hint bit set OR not set?",
      "range": {
        "startLine": 63,
        "startChar": 2,
        "endLine": 65,
        "endChar": 33
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "41689291_67cd66c1",
        "filename": "lib/smc/aarch64/smc.c",
        "patchSetId": 11
      },
      "lineNbr": 65,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-08T11:22:23Z",
      "side": 1,
      "message": "\u003e Why do we directly associate the SVE hint bit passed through SMC to the trap control?\n\nThanks for your comments.\n\nThe previous design used a global array of sve hint flag and indexed using the cpu id. This had dependencies on platform macros and helpers. We wanted to remove platform dependencies in realm payload. So the current design removes the global array and uses the SVE field in control register to represent SVE hint bit. \n\nOn a SVE capable CPU, if SVE is disabled in control register then SVE hint bit set to 1 else set to 0. If the CPU do not support SVE, then sve hint bit is set to 0.\n\n\u003e As we can have traps disabled and SVE hint bit set OR not set?\n\nWith the new logic, we can\u0027t have traps disabled and SVE hint bit set combination.",
      "parentUuid": "e15b9838_03a5f573",
      "range": {
        "startLine": 63,
        "startChar": 2,
        "endLine": 65,
        "endChar": 33
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d9846527_d31e4a4c",
        "filename": "lib/smc/aarch64/smc.c",
        "patchSetId": 11
      },
      "lineNbr": 65,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-28T17:11:11Z",
      "side": 1,
      "message": "I  agree, there is no testing requirement to keep SVE enabled and SVE hint bit set. So this coupling seems logical. If there is a future requirement to decouple, we can do the necessary change.",
      "parentUuid": "41689291_67cd66c1",
      "range": {
        "startLine": 63,
        "startChar": 2,
        "endLine": 65,
        "endChar": 33
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9ae7ecb0_e967d735",
        "filename": "lib/smc/aarch64/smc.c",
        "patchSetId": 11
      },
      "lineNbr": 65,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-29T09:12:39Z",
      "side": 1,
      "message": "\u003e there is no testing requirement to keep SVE enabled and SVE hint bit set.\n\nDoes this relate to Realm payload specific testing requirements?\n\nThis file is a generic layer, I don\u0027t see how this is generically correct wrt SMCCC.\nAn endpoint can decide to leave SVE traps disabled and deliberately set the hint bit because the context at the SMC call site is known to have no dependency towards the SVE live state.",
      "parentUuid": "d9846527_d31e4a4c",
      "range": {
        "startLine": 63,
        "startChar": 2,
        "endLine": 65,
        "endChar": 33
      },
      "revId": "f51674733d3c218fe35a7ce013d32ffeb107e3d0",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    }
  ]
}