{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "444f30ce_55f6b1cf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-28T17:20:47Z",
      "side": 1,
      "message": "Just a heads up, We are looking to merge these patches in the next couple of days.",
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dda14f95_87ac3afc",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-28T14:18:40Z",
      "side": 1,
      "message": "I think this is slightly wrong because this isn\u0027t about an FF-A call but a platform SiP SMC call.",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5c3e01ca_35b70c8e",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-28T14:40:22Z",
      "side": 1,
      "message": "hmm, that can be done separately as this is not a problem introduced in this patch ?",
      "parentUuid": "dda14f95_87ac3afc",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "53a6d3d4_172de0e9",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-28T14:44:34Z",
      "side": 1,
      "message": "At this call site, it was using tftf_smc and not ffa_service_call for this reason.\nI agree it may work like this but looks semantically incorrect.",
      "parentUuid": "5c3e01ca_35b70c8e",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b3f26094_7af400db",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000098
      },
      "writtenOn": "2023-11-28T15:46:57Z",
      "side": 1,
      "message": "I agree with Olivier. This is a platform specific SMC call and not an FF-A ABI.",
      "parentUuid": "53a6d3d4_172de0e9",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd7f1aba_ebc2153b",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-28T17:17:25Z",
      "side": 1,
      "message": "\u003e ... This is a platform specific SMC call and not an FF-A ABI.\n\nI had to add this fix to progress on SVE hint bit support patches. As with the SVE hint support, tftf_smc will set SMC.FID[16] to 1 if CPU supports SVE and SVE traps are set in CPTR_EL2/CPACR_EL1 register to denote absence of live sve state.\n\nUsing tftf_smc, this failure is seen\n\n\u003e Executing \u0027Test ESPI Secure interrupt handling\u0027\nNOTICE: SMC 0x82010100 attempted from VM 0x8001, blocked\u003d1\nERROR:   Interrupt 5000 not serviced by SP\n  TEST COMPLETE                                                 Failed\n\nNow it looks like the best place to fix this is in Hafnium, to discard sve hint bit as part of function identification.\n\n``` c\n+++ b/src/arch/aarch64/hypervisor/handler.c\n@@ -829,6 +829,13 @@ static struct vcpu *smc_handler(struct vcpu *vcpu)\n       struct ffa_value args \u003d arch_regs_get_args(\u0026vcpu-\u003eregs);\n       struct vcpu *next \u003d NULL;\n\n+       /*\n+        * Discard SVE hint bit from function identification. We don\u0027t have to\n+        * preserve this flag as Secure partitions do not support SVE.\n+        */\n+       args.func \u0026\u003d ~(1 \u003c\u003c 16);\n+\n       if (hvc_smc_handler(args, vcpu, \u0026next)) {\n\n``` c\n\nLet me know your thoughts?",
      "parentUuid": "b3f26094_7af400db",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a7ad51ac_10d29f4e",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-28T17:20:04Z",
      "side": 1,
      "message": "Or the other alternative is introduce another tftf helper \"tftf_smc_base()\" just for the purpose of this failing case and once hafnium fixes the issue, this can be removed. \n\n\nPlease let us know of your preference.",
      "parentUuid": "cd7f1aba_ebc2153b",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5e0fdbff_03291a08",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-28T17:29:57Z",
      "side": 1,
      "message": "\u003e Now it looks like the best place to fix this is in Hafnium, to discard sve hint bit as part of function identification.\n\nThis looks reasonable but to be pedantic secure partitions do not support SVE and hence have no reason to set the SVE hint bit. Hafnium returning through a controlled error path is not necessarily an issue there.\n\n\u003e Or the other alternative is introduce another tftf helper \"tftf_smc_base()\n\nWe could redefine tftf_smc in context of cactus framework, instead of importing a TFTF function into the cactus framework.\n\nI\u0027ll let Joao/Madhu decide the best course of action.",
      "parentUuid": "a7ad51ac_10d29f4e",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c1c42250_abd7a812",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-28T21:06:45Z",
      "side": 1,
      "message": "From SMCCCv1.3:\nHint bit denoting the absence of SVE specific live state.\nIf set to 1, the caller asserts that the registers P0-P15, FFR and the bits with\nindex greater than 127 in the Z0-Z31 registers do not contain any live state.\nThis bit is not part of the function identification. \n\nThe SMCCC implementation must disregard this bit and consider it to be 0 for the purpose of function identification.\n\n\nBefore SMCCCv1.3:\nMust be zero (MBZ)\n\nSo , one could say that it is not wrong for SMC calls on a SMCCCv1.3+ complaint system to set the SVE hint bit even if they dont support SVE.",
      "parentUuid": "5e0fdbff_03291a08",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "85ec9c4f_b3c21e49",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-29T09:18:56Z",
      "side": 1,
      "message": "Generally agree with the above, we\u0027ll add an Hafnium fix for cleanliness.\nHowever, I believe there is an unclear assumption about the coupling of the SMC hint bit value to the SVE trap state.\nBeyond the debatable assumption, this creates an unnecessary overhead within secure partitions for each SMC call (SVE feature should always show as disabled).\nCurrently the emulated SVE feature id returns as enabled (fixed in the Hafnium SME patch stack under review) and hence as a side effect because of the coupling the SMC hint bit is set and triggers the Hafnium error return that Arun mentioned.\nAs an alternative I suggested that this overhead is only added to the TFTF image (and perhaps to Realm payload is necessary) by enclosing it with an IMAGE_TFTF condition.",
      "parentUuid": "c1c42250_abd7a812",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "149ae040_1f9f9d8e",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-29T12:13:42Z",
      "side": 1,
      "message": "\u003e this creates an unnecessary overhead within secure partitions for each SMC call (SVE feature should always show as disabled).\n\n\u003e We could redefine tftf_smc in context of cactus framework, instead of importing a TFTF function into the cactus framework.\n\nI think the solution here is for cactus framework to have its own tftf_smc for Platform calls. We cannot use IMGE_TFTF since the same helpers are reused for Realm payload. Also using per-cpu arrays and other platform specific macros are not helpful to lib functions which need to be recompiled for Realm payload and TFTF.\n\nShall we submit a rework of the patch wherein this API calls a tftf_smc_core() ?\n\n\u003e  hence as a side effect because of the coupling the SMC hint bit is set and triggers the Hafnium error return that Arun mentioned.\n\nThe coupling issue is discussed in the later patch , we can continue discussion there.",
      "parentUuid": "85ec9c4f_b3c21e49",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "67d9f75e_b20e9eeb",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2023-11-29T20:23:37Z",
      "side": 1,
      "message": "\u003e Shall we submit a rework of the patch wherein this API calls a tftf_smc_core() ? [1]\n\u003e I think the solution here is for cactus framework to have its own tftf_smc for Platform calls. [2]\n\nI think we agree with that we need a separate helper.\nDo you mean that [1] former tftf_smc would be renamed tftf_smc_core, and tftf_smc as in current change would call tftf_smc_core? cactus partitions would use tftf_smc_core in place of tftf_smc?\n\nOr other option [2], copy former tftf_smc locally into cactus framework omitting the logic around SVE hint bit and traps?\n\nEither way is ok to me.",
      "parentUuid": "149ae040_1f9f9d8e",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bcf83011_6055fff8",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000056
      },
      "writtenOn": "2023-11-30T11:50:39Z",
      "side": 1,
      "message": "thanks, OK. Will leave this decision to Arun.",
      "parentUuid": "67d9f75e_b20e9eeb",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1844a837_fc8c8a7d",
        "filename": "spm/cactus/cactus_tests/cactus_test_interrupts.c",
        "patchSetId": 1
      },
      "lineNbr": 259,
      "author": {
        "id": 1000390
      },
      "writtenOn": "2023-11-30T16:10:02Z",
      "side": 1,
      "message": "\u003e [2], copy former tftf_smc locally into cactus framework omitting the logic around SVE hint bit and traps?\n\n\u003e Will leave this decision to Arun.\n\nThere is an existing assembler routine asm_tftf_smc64() that is used by tftf_smc. So for making platform SiP SMC call I will use asm_tftf_smc() instead of ffa_service_call(). This way we don\u0027t need to add a new api.",
      "parentUuid": "bcf83011_6055fff8",
      "range": {
        "startLine": 259,
        "startChar": 1,
        "endLine": 259,
        "endChar": 40
      },
      "revId": "71369d0a7798d7d4cd0bf785905f52845b6356de",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    }
  ]
}